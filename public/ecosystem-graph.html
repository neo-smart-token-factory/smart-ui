<!DOCTYPE html>
<!--
  NE√ò Ecosystem Graph ‚Äî Vis√£o COMPLETA (pr√©-lan√ßamento)
  Todos os repos (p√∫blicos + privados), componentes, workflows.
  Conex√µes rastreadas em profundidade. Dados: ecosystem-graph-data.js
-->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>NE√ò Ecosystem Graph ‚Äî Repos &amp; Conex√µes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="./ecosystem-graph-data.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0E0E0E; color: #fff; overflow: hidden; }
        #graph { width: 100vw; height: 100vh; }
        .controls { position: absolute; top: 20px; left: 20px; background: rgba(17,18,20,.95); border: 1px solid #D8F244; border-radius: 12px; padding: 20px; z-index: 1000; }
        .controls h2 { color: #D8F244; margin-bottom: 15px; font-size: 18px; }
        .controls button { background: linear-gradient(135deg, #D8F244, #00E5FF); color: #0E0E0E; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 5px; }
        .controls .note { font-size: 11px; color: #888; margin-top: 12px; max-width: 200px; }
        .legend { position: absolute; bottom: 20px; right: 20px; background: rgba(17,18,20,.95); border: 1px solid #D8F244; border-radius: 12px; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .legend h3 { color: #D8F244; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; margin: 8px 0; font-size: 13px; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .legend-color.repo-public { background: #FF2E9A; }
        .legend-color.repo-private { background: #F59E0B; }
        .legend-color.workflow { background: #9333EA; }
        .legend-color.component { background: #10B981; }
        .legend-color.connected { background: #D8F244; width: 20px; height: 4px; border-radius: 2px; }
        .legend-color.not-connected { background: #666; width: 20px; height: 4px; border-radius: 2px; }
        .info-panel { position: absolute; top: 20px; right: 20px; background: rgba(17,18,20,.95); border: 1px solid #FF2E9A; border-radius: 12px; padding: 20px; max-width: 340px; max-height: 80vh; overflow-y: auto; display: none; z-index: 1000; }
        .info-panel.active { display: block; }
        .info-panel h3 { color: #D8F244; margin-bottom: 10px; }
        .info-panel .type { font-size: 11px; color: #888; margin-bottom: 8px; }
        .info-panel p, .info-panel ul { font-size: 13px; line-height: 1.6; margin: 5px 0; }
        .info-panel ul { padding-left: 18px; }
        .node { cursor: pointer; }
        .node:hover { filter: brightness(1.3); }
        .node-label { font-size: 11px; font-weight: 600; pointer-events: none; text-shadow: 0 0 4px #0E0E0E; }
        .link { stroke-opacity: 0.85; }
        .link.not-connected { stroke-dasharray: 6,4; stroke: #666; stroke-opacity: 0.5; }
        .link-label { font-size: 9px; fill: #D8F244; text-anchor: middle; pointer-events: none; }
        .link-label.not-connected { fill: #888; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>üéõÔ∏è Controles</h2>
        <button type="button" id="btnReset">üîÑ Reset</button>
        <button type="button" id="btnPhysics">‚ö° F√≠sica: ON</button>
        <button type="button" id="btnCenter">üéØ Centralizar</button>
        <p class="note">Pr√©-lan√ßamento: inclui repos privados. Conex√µes rastreadas em profundidade.</p>
    </div>
    <div class="legend">
        <h3>Legenda</h3>
        <div class="legend-item"><div class="legend-color repo-public"></div><span>Repo p√∫blico</span></div>
        <div class="legend-item"><div class="legend-color repo-private"></div><span>Repo privado</span></div>
        <div class="legend-item"><div class="legend-color workflow"></div><span>Workflow / CI</span></div>
        <div class="legend-item"><div class="legend-color component"></div><span>Componente</span></div>
        <div class="legend-item" style="margin-top:10px;"><div class="legend-color connected"></div><span>Conectados</span></div>
        <div class="legend-item"><div class="legend-color not-connected"></div><span>N√£o conectados (tracejado)</span></div>
    </div>
    <div class="info-panel" id="infoPanel">
        <h3 id="infoTitle">Selecione um n√≥</h3>
        <p class="type" id="infoType"></p>
        <p id="infoDescription"></p>
        <p id="infoConnections"></p>
        <p id="infoNotConnected"></p>
    </div>
    <svg id="graph"></svg>
    <script>
        (function() {
            if (typeof d3 === 'undefined' || typeof NEO_ECOSYSTEM_GRAPH_DATA === 'undefined') {
                document.body.innerHTML = '<div style="padding:40px;color:#fff;text-align:center;"><h1>Erro</h1><p>D3 ou ecosystem-graph-data.js n√£o carregou.</p></div>';
                return;
            }
            const data = NEO_ECOSYSTEM_GRAPH_DATA;
            const nodes = data.nodes.map(n => ({ ...n }));
            const edges = data.edges.map(e => ({ ...e, source: e.source, target: e.target }));
            const notConnected = (data.notConnected || []).map(n => ({ ...n }));

            const typeColor = { 'repo-public': '#FF2E9A', 'repo-private': '#F59E0B', 'workflow': '#9333EA', 'component': '#10B981' };
            const typeLabel = { 'repo-public': 'Repo p√∫blico', 'repo-private': 'Repo privado', 'workflow': 'Workflow / CI', 'component': 'Componente' };
            const radius = d => (d.type && d.type.startsWith('repo')) ? 26 : (d.type === 'workflow' ? 20 : 16);

            const width = window.innerWidth, height = window.innerHeight;
            const svg = d3.select('#graph').attr('width', width).attr('height', height);
            const g = svg.append('g');

            const zoom = d3.zoom().scaleExtent([0.15, 4]).on('zoom', ev => g.attr('transform', ev.transform));
            svg.call(zoom);

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-280))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => radius(d) + 12));

            const link = g.append('g').attr('class', 'links')
                .selectAll('line')
                .data(edges)
                .join('line')
                .attr('class', 'link')
                .attr('stroke', '#D8F244')
                .attr('stroke-width', 1.5);

            const linkLabel = g.append('g').attr('class', 'link-labels')
                .selectAll('text')
                .data(edges)
                .join('text')
                .attr('class', 'link-label')
                .text(d => d.label);

            const ncLines = g.append('g').attr('class', 'not-connected-lines')
                .selectAll('line')
                .data(notConnected)
                .join('line')
                .attr('class', 'link not-connected')
                .attr('stroke-width', 1);

            const ncLabels = g.append('g').attr('class', 'not-connected-labels')
                .selectAll('text')
                .data(notConnected)
                .join('text')
                .attr('class', 'link-label not-connected')
                .text(d => d.reason || 'n√£o conectado');

            const node = g.append('g').attr('class', 'nodes')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', 'node')
                .call(d3.drag().on('start', dragstart).on('drag', dragged).on('end', dragend))
                .on('click', showInfo);

            node.append('circle')
                .attr('r', radius)
                .attr('fill', d => typeColor[d.type] || '#666')
                .attr('stroke', '#0E0E0E')
                .attr('stroke-width', 2);
            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', d => radius(d) + 14)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .text(d => d.label);

            function nodeById(id) { return nodes.find(n => n.id === id); }

            simulation.on('tick', () => {
                link
                    .attr('x1', d => (d.source.x ?? nodeById(d.source)?.x ?? 0))
                    .attr('y1', d => (d.source.y ?? nodeById(d.source)?.y ?? 0))
                    .attr('x2', d => (d.target.x ?? nodeById(d.target)?.x ?? 0))
                    .attr('y2', d => (d.target.y ?? nodeById(d.target)?.y ?? 0));
                linkLabel
                    .attr('x', d => ((d.source.x ?? nodeById(d.source)?.x ?? 0) + (d.target.x ?? nodeById(d.target)?.x ?? 0)) / 2)
                    .attr('y', d => ((d.source.y ?? nodeById(d.source)?.y ?? 0) + (d.target.y ?? nodeById(d.target)?.y ?? 0)) / 2);
                ncLines
                    .attr('x1', d => (nodeById(d.source)?.x ?? 0))
                    .attr('y1', d => (nodeById(d.source)?.y ?? 0))
                    .attr('x2', d => (nodeById(d.target)?.x ?? 0))
                    .attr('y2', d => (nodeById(d.target)?.y ?? 0));
                ncLabels
                    .attr('x', d => ((nodeById(d.source)?.x ?? 0) + (nodeById(d.target)?.x ?? 0)) / 2)
                    .attr('y', d => ((nodeById(d.source)?.y ?? 0) + (nodeById(d.target)?.y ?? 0)) / 2);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstart(ev, d) { if (!ev.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
            function dragged(ev, d) { d.fx = ev.x; d.fy = ev.y; }
            function dragend(ev, d) { if (!ev.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

            function showInfo(ev, d) {
                ev.stopPropagation();
                const conn = edges.filter(e => {
                    const s = typeof e.source === 'object' ? e.source.id : e.source;
                    const t = typeof e.target === 'object' ? e.target.id : e.target;
                    return s === d.id || t === d.id;
                });
                const nc = notConnected.filter(n => n.source === d.id || n.target === d.id);
                document.getElementById('infoTitle').textContent = d.label;
                document.getElementById('infoType').textContent = typeLabel[d.type] || d.type || '';
                document.getElementById('infoDescription').textContent = d.description || '';
                document.getElementById('infoConnections').innerHTML = conn.length
                    ? '<strong>Conectado a:</strong><ul>' + conn.map(e => {
                        const other = (typeof e.source === 'object' ? e.source.id : e.source) === d.id
                            ? (typeof e.target === 'object' ? e.target.id : e.target)
                            : (typeof e.source === 'object' ? e.source.id : e.source);
                        return '<li>' + other + ' ‚Äî ' + (e.label || '') + '</li>';
                    }).join('') + '</ul>'
                    : '<strong>Conectado a:</strong> nenhum.';
                document.getElementById('infoNotConnected').innerHTML = nc.length
                    ? '<strong>N√£o conectado a:</strong><ul>' + nc.map(n => {
                        const other = n.source === d.id ? n.target : n.source;
                        return '<li>' + other + ' ‚Äî ' + (n.reason || '') + '</li>';
                    }).join('') + '</ul>'
                    : '';
                document.getElementById('infoPanel').classList.add('active');
                node.style('opacity', n => n === d ? 1 : 0.3);
                link.style('opacity', l => {
                    const s = typeof l.source === 'object' ? l.source.id : l.source;
                    const t = typeof l.target === 'object' ? l.target.id : l.target;
                    return s === d.id || t === d.id ? 1 : 0.15;
                });
                ncLines.style('opacity', l => l.source === d.id || l.target === d.id ? 0.9 : 0.15);
            }

            svg.on('click', function(ev) {
                if (ev.target === this || ev.target.closest?.('.link')) {
                    document.getElementById('infoPanel').classList.remove('active');
                    node.style('opacity', 1);
                    link.style('opacity', 0.85);
                    ncLines.style('opacity', 0.5);
                }
            });

            document.getElementById('btnReset').onclick = () => {
                simulation.alpha(1).restart();
                svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            };
            let physicsOn = true;
            document.getElementById('btnPhysics').onclick = () => {
                physicsOn = !physicsOn;
                const btn = document.getElementById('btnPhysics');
                if (physicsOn) { simulation.alpha(0.3).restart(); btn.textContent = '‚ö° F√≠sica: ON'; }
                else { simulation.stop(); btn.textContent = '‚ö° F√≠sica: OFF'; }
            };
            document.getElementById('btnCenter').onclick = () => {
                svg.transition().duration(750).call(zoom.transform,
                    d3.zoomIdentity.translate(width / 2, height / 2).scale(0.8));
            };

            simulation.alpha(1).restart();
        })();
    </script>
</body>
</html>
